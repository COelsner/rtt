<?xml version="1.0" encoding="UTF-8"?>
<!--
	This program and the accompanying materials are made available under the
	terms of the MIT license (X11 license) which accompanies this distribution.
-->

<!--
	Ant build script to generate RTT's Java XML bindings (JAXB) and its
	distributions.
	@author C. BÃ¼rger
-->

<project name="rtt" default="Jar">
	<dirname file="${ant.file.rtt}" property="rtt.base" />

	<!-- Definitions of the JAXB ant tasks -->
	<import file="${rtt.base}/build-scripts/jaxb.xml" />

	<!-- Important directories -->
	<property name="distr.dir" location="${rtt.base}/distribution" />
	<property name="licenses.dir" location="${rtt.base}/LICENSES"/>
	<property name="src.dir" location="${rtt.base}/implementation" />
	<property name="src-gen.dir" location="${rtt.base}/src-gen" />
	<property name="src-tests.dir" location="${rtt.base}/tests/src" />
	<property name="bin.dir" location="${rtt.base}/binary" />
	
	<!-- library locations -->
	<property name="lib.dir" location="${rtt.base}/libraries" />
	<property name="runtime.dir" location="${lib.dir}/runtime" />
	<property name="junit.dir" location="${lib.dir}/development/junit" />
	<property name="plugin.dir" location="${lib.dir}/plugin" />

	<!-- Name of the jar and source file-->
	<property name="distr.jar.name" value="rtt" />
	<property name="distr.jar.path" location="${distr.dir}/${distr.jar.name}.jar" />
	<property name="distr.src.name" value="rtt_src" />
	
	<path id="libs.junit">
		<fileset dir="${junit.dir}" includes="**/*.jar"/>
	</path>
	
	<path id="libs.runtime">
		<fileset dir="${runtime.dir}" includes="**/*.jar"/>
	</path>

	<!-- Refresh all classes and create jar -->
	<target name="RefreshAll">
		<antcall target="XJC ALL" />
		<antcall target="Jar" />
	</target>

	<target name="Clean Distribution">
		<delete includeemptydirs="true">
			<fileset dir="${distr.dir}">
				<include name="${distr.jar.name}.jar" />
				<include name="${distr.src.name}.zip" />
				<include name="javadoc/**/*" />
			</fileset>
		</delete>
	</target>

	<target name="Clean">
		<antcall target="Clean XJC" />
		<delete dir="${bin.dir}" failonerror="false" />
	</target>

	<target name="Compile">
		<antcall target="XJC ALL" />
		<mkdir dir="${bin.dir}"/>
		<javac srcdir="${src.dir}:${src-gen.dir}:${src-tests.dir}" 
			   destdir="${bin.dir}"
			   includeantruntime="false">
			<classpath>
				<path refid="libs.junit" />
				<path refid="libs.runtime" />
			</classpath>
			<exclude name="rtt/core/RTTApplication.java" />
			<exclude name="rtt/core/classpath/**/*" />
		</javac>
	</target>

	<!-- Create *.jar distribution -->
	<target name="Jar">
		<jar destfile="${distr.jar.path}" index="false" update="false" compress="false">
			<manifest>
				<attribute name="Main-Class" value="rtt.core.RegressionTestTool" />
			</manifest>

			<!-- integrate third-party libraries -->
                        <zipgroupfileset dir="${runtime.dir}" includes="**/*.jar" />

			<!-- add license informations -->
			<zipfileset dir="${licenses.dir}" includes="*.txt" prefix="LICENSES"/>

			<!-- logback config file -->
			<fileset dir="${rtt.base}">
				<include name="logback.xml"/>
			</fileset>

			<fileset dir="${src.dir}">
				<include name="**/taskdef.properties" />
			</fileset>
			<fileset dir="${rtt.schemes}">
				<include name="**/*.xsd" />
				<include name="**/*.xslt" />
			</fileset>
			<fileset dir="${bin.dir}">
				<include name="**/*.class" />
				<exclude name="rtt/tests/**/*" />
			</fileset>
		</jar>
	</target>
	
	<target name="Test" depends="Clean, Compile, Jar">
	    <mkdir dir="${plugin.dir}" />
	    <copy file="${distr.jar.path}" tofile="${plugin.dir}/ant-lib.jar" />
	    <ant antfile="${rtt.base}/tests/junit-tests.xml" />
	</target>

	<!-- Create source code distribution -->
	<target name="SrcDistribution" depends="Clean XJC, Clean Distribution">
		<zip destfile="${distr.dir}/${distr.src.name}.zip" encoding="UTF-8" compress="true" update="false">
			<fileset dir="${rtt.base}">
				<include name="**/*" />
				<exclude name="binary" />
				<exclude name="binary/**/*" />
				<exclude name="distribution" />
				<exclude name="distribution/**/*" />
			</fileset>
		</zip>
	</target>

	<!-- Creates Javadoc (todo) -->
	<target name="Javadoc">
		<javadoc access="public" author="true" destdir="${distr.dir}/javadoc" nodeprecated="false" nodeprecatedlist="false" noindex="false" nonavbar="false" notree="false" source="1.6" splitindex="true" use="true" version="true" overview="${src.dir}/overview.html">
			<sourcepath>
				<pathelement path="${src.dir}"/>
				<pathelement path="${rtt.src-gen}"/>
			</sourcepath>

			<package name="rtt.*"/>
			<excludepackage name="rtt.core.classpath" />

			<doctitle>Regression Test Tool (RTT) - API</doctitle>

			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</javadoc>
	</target>
</project>
